# ace5pro ä¸»å·¥ä½œæµ
# è¿™æ˜¯ä¸€ä¸ª GitHub Actions å·¥ä½œæµï¼Œç”¨äºç¼–è¯‘ Android å†…æ ¸ã€‚
# å®ƒå®šä¹‰äº†è§¦å‘æ¡ä»¶ã€è¾“å…¥å‚æ•°ä»¥åŠä¸€ç³»åˆ—æ„å»ºæ­¥éª¤ã€‚

name: ace5pro-afdo-build

# å®šä¹‰å·¥ä½œæµçš„è§¦å‘æ¡ä»¶
on:
  # å½“æ‰‹åŠ¨è§¦å‘å·¥ä½œæµæ—¶
  workflow_dispatch:
    # å®šä¹‰å·¥ä½œæµçš„è¾“å…¥å‚æ•°
    inputs:
      CPU:
        description: "åˆ†æ”¯åç§°ï¼Œä¾‹å¦‚ sm8750"
        required: true
        default: "sm8750"
      FEIL:
        description: "é…ç½®æ–‡ä»¶åç§°ï¼Œä¾‹å¦‚ oneplus_ace5_pro"
        required: true
        default: "oneplus_ace5_pro"
      ANDROID_VERSION:
        description: "å†…æ ¸å¯¹åº”çš„ Android ç‰ˆæœ¬ï¼Œä¾‹å¦‚ android15"
        required: true
        default: "android15"
      KERNEL_VERSION:
        description: "å†…æ ¸ç‰ˆæœ¬ï¼Œä¾‹å¦‚ 6.6"
        required: true
        default: "6.6"
      KERNEL_NAME:
        description: "ä¿®æ”¹åçš„å†…æ ¸åç§°åç¼€"
        required: true
        default: "-android15-8-g013ec21bba94-abogki383916444"
      ENABLE_KPM:
        description: "æ˜¯å¦å¯ç”¨ KPM (Kernel Patch Manager)"
        required: false
        default: false
        type: boolean
      local_version:
        description: "è¾“å…¥å†…æ ¸åç¼€åï¼ˆå¦‚-v8ï¼‰"
        required: false
        default: "-4k"
        type: string
      kernel_time:
        description: "å†…æ ¸æ„å»ºæ—¶é—´ï¼ˆUTC æ—¶é—´å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ \"Tue Dec 17 23:36:49 UTC 2024\"ï¼‰"
        required: false
        default: "Tue Dec 17 23:36:49 UTC 2024"
        type: string
      ENABLE_LTO:
        description: "æ˜¯å¦å¯ç”¨ LTO (Link Time Optimization) é“¾æ¥æ—¶ä¼˜åŒ–"
        required: false
        default: false
        type: boolean

# å®šä¹‰å·¥ä½œæµä¸­çš„ä»»åŠ¡
jobs:
  build:
    # æŒ‡å®šè¿è¡Œç¯å¢ƒä¸ºæœ€æ–°çš„ Ubuntu
    runs-on: ubuntu-latest
    # å®šä¹‰ç¯å¢ƒå˜é‡
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      TOKEN: ${{ secrets.TOKEN }} # ä» GitHub Secrets è·å– TOKEN
    # å®šä¹‰æ„å»ºæ­¥éª¤
    steps:
      # æ­¥éª¤ï¼šæœ€å¤§åŒ–æ„å»ºç©ºé—´
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192 # æ ¹ç›®å½•ä¿ç•™ç©ºé—´
          temp-reserve-mb: 2048 # ä¸´æ—¶ç›®å½•ä¿ç•™ç©ºé—´
          remove-dotnet: "true" # ç§»é™¤ .NET
          remove-android: "true" # ç§»é™¤ Android SDK
          remove-haskell: "true" # ç§»é™¤ Haskell
          remove-codeql: "true" # ç§»é™¤ CodeQL
          
      # æ­¥éª¤ï¼šé…ç½® Git
      - name: Configure Git
        run: |
         git config --global user.name "build" # è®¾ç½® Git ç”¨æˆ·å
         git config --global user.email "3620603668@qq.com" # è®¾ç½® Git ç”¨æˆ·é‚®ç®±
      # 1. æ‹‰å–ä»“åº“  
      - name: Checkout  
        uses: actions/checkout@v4  # ä½¿ç”¨ actions/checkout@v4 åŠ¨ä½œæ‹‰å–ä»£ç 

      # 2. å®‰è£…æ„å»ºä¾èµ–ï¼ˆåŒ…æ‹¬ ccacheï¼‰  
      - name: Install Dependencies  
        run: |  
         sudo apt-get update  # æ›´æ–° apt åŒ…åˆ—è¡¨
         sudo apt-get install -y python3 git curl ccache libelf-dev  # å®‰è£…å¿…è¦çš„ä¾èµ–ï¼šPython3, Git, Curl, ccache, libelf-dev
      # 3. æ¢å¤ ccache ç¼“å­˜  
      - name: Restore ccache
        uses: actions/cache@v3 # ä½¿ç”¨ actions/cache@v3 åŠ¨ä½œæ¢å¤ ccache ç¼“å­˜
        with:
         path: /home/runner/.ccache # ccache ç¼“å­˜è·¯å¾„
         key: ${{ runner.os }}-${{ github.repository }}-ccache-${{ github.workflow }}-v4 # ç¼“å­˜é”®
         restore-keys: | # æ¢å¤é”®åˆ—è¡¨
          ${{ runner.os }}-${{ github.repository }}-ccache-${{ github.workflow }}-v4
          ${{ runner.os }}-${{ github.repository }}-
          ${{ runner.os }}-
      # 4. è®¾ç½® ccache ç¯å¢ƒå˜é‡  
      - name: Setup ccache environment  
        run: |  
         echo "CCACHE_DIR=/home/runner/.ccache" >> $GITHUB_ENV  # è®¾ç½® ccache ç›®å½•
         echo "CCACHE_MAXSIZE=8G" >> $GITHUB_ENV  # è®¾ç½® ccache æœ€å¤§å¤§å°
         echo "CCACHE_COMPILERCHECK=%compiler% -dumpmachine; %compiler% -dumpversion" >> $GITHUB_ENV  # è®¾ç½®ç¼–è¯‘å™¨æ£€æŸ¥
         echo "CCACHE_NOHASHDIR=true" >> $GITHUB_ENV  # ä¸å¯¹ç›®å½•è¿›è¡Œå“ˆå¸Œ
         echo "CCACHE_HARDLINK=true" >> $GITHUB_ENV  # ä½¿ç”¨ç¡¬é“¾æ¥
         echo "CCACHE_BASEDIR=${{ github.workspace }}" >> $GITHUB_ENV  # è®¾ç½® ccache åŸºç¡€ç›®å½•
         echo "CCACHE_LOGFILE=${{ github.workspace }}/ccache.log" >> $GITHUB_ENV  # è®¾ç½® ccache æ—¥å¿—æ–‡ä»¶
         echo "/usr/lib/ccache" >> $GITHUB_PATH  # å°† ccache æ·»åŠ åˆ° PATH ç¯å¢ƒå˜é‡
         
      # æ­¥éª¤ï¼šæ˜¾ç¤º ccache ç»Ÿè®¡ä¿¡æ¯
      - name: Show ccache stats
        run: |
         ccache -s || true # æ˜¾ç¤º ccache ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚æœå¤±è´¥åˆ™å¿½ç•¥é”™è¯¯
      # æ­¥éª¤ï¼šå®‰è£… repo å·¥å…·
      - name: Install repo tool
        run: |
         curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo # ä¸‹è½½ repo å·¥å…·
         chmod a+x ~/repo # æ·»åŠ æ‰§è¡Œæƒé™
         sudo mv ~/repo /usr/local/bin/repo # å°† repo ç§»åŠ¨åˆ° /usr/local/bin
      # æ­¥éª¤ï¼šåˆå§‹åŒ– repo å¹¶åŒæ­¥ä»£ç 
      - name: Initialize repo and sync
        run: |
         mkdir kernel_workspace && cd kernel_workspace # åˆ›å»ºå†…æ ¸å·¥ä½œç©ºé—´å¹¶è¿›å…¥
         repo init -u https://github.com/OnePlusOSS/kernel_manifest.git -b refs/heads/oneplus/${{ github.event.inputs.CPU }} -m ${{ github.event.inputs.FEIL }}.xml --depth=1 # åˆå§‹åŒ– repo
         repo --trace sync -c -j$(nproc --all) --no-tags # åŒæ­¥ä»£ç 
         rm kernel_platform/common/android/abi_gki_protected_exports_* || echo "No protected exports!" # ç§»é™¤å—ä¿æŠ¤çš„å¯¼å‡ºæ–‡ä»¶
         rm kernel_platform/msm-kernel/android/abi_gki_protected_exports_* || echo "No protected exports!" # ç§»é™¤å—ä¿æŠ¤çš„å¯¼å‡ºæ–‡ä»¶
         
      # æ­¥éª¤ï¼šè®¾ç½® SukiSU
      - name: Set up SukiSU
        run: |
         cd kernel_workspace/kernel_platform # è¿›å…¥å†…æ ¸å¹³å°ç›®å½•
         curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-main # ä¸‹è½½å¹¶æ‰§è¡Œ SukiSU å®‰è£…è„šæœ¬
         cd ./KernelSU # è¿›å…¥ KernelSU ç›®å½•
         KSU_VERSION=$(expr $(/usr/bin/git rev-list --count main) "+" 10606) # è®¡ç®— KSU ç‰ˆæœ¬å·
         echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV # è®¾ç½® KSUVER ç¯å¢ƒå˜é‡
         export KSU_VERSION=$KSU_VERSION # å¯¼å‡º KSU_VERSION ç¯å¢ƒå˜é‡
         sed -i "s/DKSU_VERSION=12800/DKSU_VERSION=${KSU_VERSION}/" kernel/Makefile # ä¿®æ”¹ KernelSU çš„ Makefile
      # æ­¥éª¤ï¼šè®¾ç½® SUSFS å¹¶åº”ç”¨è¡¥ä¸
      - name: Set up SUSFS & apply patches
        run: |
         set -e # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
         cd kernel_workspace # è¿›å…¥å†…æ ¸å·¥ä½œç©ºé—´
         git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ inputs.ANDROID_VERSION }}-${{ inputs.KERNEL_VERSION }} # å…‹éš† susfs4ksu ä»“åº“
         git clone --depth=1 https://github.com/SukiSU-Ultra/SukiSU_patch.git # å…‹éš† SukiSU_patch ä»“åº“
         git clone https://$TOKEN@github.com/3620603660/boot.git # å…‹éš† boot ä»“åº“
         cd kernel_platform # è¿›å…¥å†…æ ¸å¹³å°ç›®å½•
         cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ inputs.ANDROID_VERSION }}-${{ inputs.KERNEL_VERSION }}.patch ./common/ || true # å¤åˆ¶ SUSFS è¡¥ä¸
         mkdir -p ./common/fs ./common/include/linux ./common/lib ./common/crypto # åˆ›å»ºç›®å½•
         cp ../susfs4ksu/kernel_patches/fs/* ./common/fs/ || true # å¤åˆ¶æ–‡ä»¶ç³»ç»Ÿç›¸å…³è¡¥ä¸
         cp ../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/ || true # å¤åˆ¶ Linux å¤´æ–‡ä»¶ç›¸å…³è¡¥ä¸
         cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./common/include/linux || true # å¤åˆ¶ LZ4K ç›¸å…³å¤´æ–‡ä»¶
         cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./common/lib || true # å¤åˆ¶ LZ4K ç›¸å…³åº“æ–‡ä»¶
         cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./common/crypto || true # å¤åˆ¶ LZ4K ç›¸å…³åŠ å¯†æ–‡ä»¶
         cp -r ../SukiSU_patch/other/zram/lz4k_oplus ./common/lib/ || true # å¤åˆ¶ LZ4K Oplus ç›¸å…³æ–‡ä»¶
         cp ../boot/1.patch ./common/ # å¤åˆ¶ boot è¡¥ä¸
         cd ./common # è¿›å…¥ common ç›®å½•
         PATCH_FILE=50_add_susfs_in_gki-${{ inputs.ANDROID_VERSION }}-${{ inputs.KERNEL_VERSION }}.patch # å®šä¹‰è¡¥ä¸æ–‡ä»¶å˜é‡
         if [[ -f "$PATCH_FILE" ]]; then # å¦‚æœè¡¥ä¸æ–‡ä»¶å­˜åœ¨
         sed -i "s/-32,12 +32,38/-32,11 +32,37/g" "$PATCH_FILE" # ä¿®æ”¹è¡¥ä¸æ–‡ä»¶å†…å®¹
         sed -i "/#include <trace\/hooks\/fs.h>/d" "$PATCH_FILE" # åˆ é™¤è¡¥ä¸æ–‡ä»¶ä¸­çš„ç‰¹å®šè¡Œ
         patch -p1 < "$PATCH_FILE" || true # åº”ç”¨è¡¥ä¸
         fi
         cp ../../SukiSU_patch/hooks/syscall_hooks.patch ./ # å¤åˆ¶ syscall_hooks è¡¥ä¸
         patch -p1 -F 3 < syscall_hooks.patch || true # åº”ç”¨ syscall_hooks è¡¥ä¸
         patch -s -p1 -F 3 < 1.patch # åº”ç”¨ 1.patch è¡¥ä¸
         echo "âœ… SUSFS å’Œ syscall_hooks patch åº”ç”¨å®Œæˆ" # è¾“å‡ºæˆåŠŸä¿¡æ¯


      # æ­¥éª¤ï¼šåº”ç”¨ lz4kd è¡¥ä¸å¹¶æ›´æ–°å‹ç¼©åº“
      - name: Apply lz4kd Patches and Update Compression Libraries
        run: |
         set -e # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
         cd kernel_workspace/kernel_platform/common # è¿›å…¥ common ç›®å½•
         PATCH_FILE=../../SukiSU_patch/other/zram/zram_patch/${{ inputs.KERNEL_VERSION }}/lz4kd.patch # å®šä¹‰ lz4kd è¡¥ä¸æ–‡ä»¶å˜é‡
         if [[ -f "$PATCH_FILE" ]]; then # å¦‚æœè¡¥ä¸æ–‡ä»¶å­˜åœ¨
         cp "$PATCH_FILE" ./lz4kd.patch # å¤åˆ¶ lz4kd è¡¥ä¸
         patch -p1 -F 3 < lz4kd.patch || true # åº”ç”¨ lz4kd è¡¥ä¸
         else
         echo "â— lz4kd patch not found for kernel version ${{ inputs.KERNEL_VERSION }}" # è¾“å‡ºè­¦å‘Šä¿¡æ¯
         fi

      - name: ğŸ”§ Update compression algorithms (æ›´æ–°å‹ç¼©ç®—æ³•)
        run: |
          cd kernel_workspace/kernel_platform/common
          # æ›´æ–° LZ4 å®ç°
          curl -sSLO https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/lib/lz4/lz4_decompress.c # ä¸‹è½½ LZ4 è§£å‹ä»£ç 
          curl -sSLO https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/lib/lz4/lz4defs.h # ä¸‹è½½ LZ4 å®šä¹‰å¤´æ–‡ä»¶
          curl -sSLO https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/lib/lz4/lz4_compress.c # ä¸‹è½½ LZ4 å‹ç¼©ä»£ç 
          curl -sSLO https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/lib/lz4/lz4hc_compress.c # ä¸‹è½½ LZ4HC å‹ç¼©ä»£ç 


           # æ›´æ–° Zstd å®ç° 
          zstd_base="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/lib/zstd" # Zstd åº“åŸºç¡€ URL
          mkdir -p lib/zstd && cd lib/zstd # åˆ›å»º lib/zstd ç›®å½•å¹¶è¿›å…¥
          curl -sSL $zstd_base/zstd_common_module.c -o common.c # ä¸‹è½½ Zstd å…¬å…±æ¨¡å—
          curl -sSL $zstd_base/compress/zstd_compress_module.c -o compress.c # ä¸‹è½½ Zstd å‹ç¼©æ¨¡å—
          curl -sSL $zstd_base/decompress/zstd_decompress_module.c -o decompress.c # ä¸‹è½½ Zstd è§£å‹æ¨¡å—
          curl -sSL $zstd_base/zstd_compat.h -o compat.h # ä¸‹è½½ Zstd å…¼å®¹å¤´æ–‡ä»¶
          cd .. # è¿”å› common ç›®å½•

          # æ­¥éª¤ï¼šæ·»åŠ  make åç§°
      - name: Add make name
        run: |
         cd kernel_workspace/kernel_platform # è¿›å…¥å†…æ ¸å¹³å°ç›®å½•
         sed -i '186s|echo ".*"|echo "${KERNELVERSION}${scm_version}${config_localversion}"|' common/scripts/setlocalversion # ä¿®æ”¹ setlocalversion è„šæœ¬
         sed -i "s/\${scm_version}/${{ github.event.inputs.KERNEL_NAME }}/g" ./common/scripts/setlocalversion # æ›¿æ¢ scm_version ä¸ºè¾“å…¥çš„å†…æ ¸åç§°
         
      # æ­¥éª¤ï¼šè®¾ç½® CONFIG_LOCALVERSION
      - name: è®¾ç½® CONFIG_LOCALVERSION
        run: |
         cd kernel_workspace/kernel_platform # è¿›å…¥å†…æ ¸å¹³å°ç›®å½•
         echo 'CONFIG_LOCALVERSION="${{ github.event.inputs.local_version }}"' >> ./common/arch/arm64/configs/gki_defconfig # è®¾ç½® CONFIG_LOCALVERSION


      # æ­¥éª¤ï¼šæ·»åŠ  sched_ext
      - name: Add sched_ext
        run: |
         cd kernel_workspace/kernel_platform/ # è¿›å…¥å†…æ ¸å¹³å°ç›®å½•
         git clone https://github.com/3620603660/sched_ext.git # å…‹éš† sched_ext ä»“åº“
         cp -r ./sched_ext/* ./common/kernel/sched # å¤åˆ¶ sched_ext æ–‡ä»¶
         rm -rf ./sched_ext/.git # ç§»é™¤ .git ç›®å½•
         
      # æ­¥éª¤ï¼šè®¾ç½®æ„å»ºæ—¶é—´æˆ³
      - name: Set build timestamp
        run: |         
         export SOURCE_DATE_EPOCH=$(date -d "Tue Dec 17 23:36:49 UTC 2024" +%s) # è®¾ç½® SOURCE_DATE_EPOCH ç¯å¢ƒå˜é‡
         echo "SOURCE_DATE_EPOCH=$SOURCE_DATE_EPOCH" >> $GITHUB_ENV # å°† SOURCE_DATE_EPOCH å†™å…¥ç¯å¢ƒå˜é‡

      # æ­¥éª¤ï¼šä¸‹è½½AFDOæ–‡ä»¶
      - name: Download kernel.afdo
        run: |
          cd kernel_workspace/kernel_platform/common
          curl -o kernel.afdo https://raw.githubusercontent.com/3620603660/egcd/refs/heads/main/kernel.afdo

            # æ­¥éª¤ï¼šç¼–è¯‘å†…æ ¸
      - name: Build kernel
        run: |
         # åŠ å…¥ clang åˆ° PATH
         export PATH="${{ github.workspace }}/kernel_workspace/kernel_platform/prebuilts/clang/host/linux-x86/clang-r510928/bin:$PATH"
         # åŠ å…¥ ccache åˆ° PATH
         export PATH="/usr/lib/ccache:$PATH"
         # è®¾ç½®å›ºå®šå†…æ ¸æ„å»ºæ—¶é—´ï¼Œä½¿ç”¨è¾“å…¥å‚æ•°
         export KERNEL_TIME="${{ github.event.inputs.kernel_time }}"
         export KBUILD_BUILD_TIMESTAMP="$KERNEL_TIME"
         export SOURCE_DATE_EPOCH=$(date -d "$KERNEL_TIME" +%s)
         # æ‰“å°éªŒè¯
         echo "KERNEL_TIME = $KERNEL_TIME"
         echo "SOURCE_DATE_EPOCH = $SOURCE_DATE_EPOCH"
         # è®¾ç½®åŸºç¡€æ„å»ºå‚æ•°
         export LLVM=1
         export ARCH=arm64
         export CROSS_COMPILE=aarch64-linux-gnu-
         export CC=clang
         export RUSTC="../../prebuilts/rust/linux-x86/1.73.0b/bin/rustc"
         export PAHOLE="../../prebuilts/kernel-build-tools/linux-x86/bin/pahole"
         export LD=ld.lld
         export HOSTLD=ld.lld
         export O=out # æŒ‡å®šè¾“å‡ºç›®å½•ä¸ºå½“å‰ç›®å½•ä¸‹çš„ 'out'

         # è¿›å…¥æºç ç›®å½•
         cd kernel_workspace/kernel_platform/common
         mkdir -p out # åœ¨å½“å‰ç›®å½•ï¼ˆcommonï¼‰ä¸‹åˆ›å»º 'out' ç›®å½•

          # æ‰§è¡Œ defconfigã€‚æ³¨æ„ï¼šgki_defconfig é€šå¸¸ä¼šå°† .config å†™å…¥å½“å‰ç›®å½•ï¼Œè€Œä¸æ˜¯ O=out æŒ‡å®šçš„ç›®å½•
         make -j$(nproc) gki_defconfig

         # --- å¼€å§‹æ¸…ç†å’Œæ·»åŠ é…ç½®åˆ°ç”Ÿæˆçš„ .config æ–‡ä»¶ ---
         # è§£å†³é‡å¤å®šä¹‰è­¦å‘Šï¼šå…ˆåˆ é™¤æ—§çš„é…ç½®ï¼Œå†æ·»åŠ æ–°çš„
         # åˆ é™¤ gki_defconfig ä¸­å¯èƒ½é‡å¤çš„é…ç½®é¡¹ï¼Œä»¥é¿å… override è­¦å‘Šå’Œæ½œåœ¨å†²çª
         # ã€æ–°å¢ã€‘ä»¥ä¸‹ sed å‘½ä»¤ï¼Œç”¨äºæ¸…ç† make gki_defconfig ç”Ÿæˆçš„ .config æ–‡ä»¶ä¸­çš„é‡å¤é¡¹
         sed -i '/CONFIG_CRYPTO_ZSTD/d' .config
         sed -i '/CONFIG_CRYPTO_LZ4/d' .config
         sed -i '/CONFIG_ZRAM/d' .config
         sed -i '/CONFIG_NET_SCHED/d' .config
         sed -i '/CONFIG_NET_SCH_FQ/d' .config
         sed -i '/CONFIG_F2FS_FS/d' .config
         sed -i '/CONFIG_F2FS_FS_SECURITY/d' .config
         sed -i '/CONFIG_F2FS_FS_COMPRESSION/d' .config
         sed -i '/CONFIG_LOCALVERSION/d' .config

         # ã€ä¿®æ”¹ã€‘å°†ç”Ÿæˆçš„ .config æ–‡ä»¶ç§»åŠ¨åˆ° out ç›®å½•
         # åŸå…ˆï¼šsed -i '/CONFIG_F2FS_FS_COMPRESSION/d' out/.config
         #       sed -i '/CONFIG_LOCALVERSION/d' out/.config
         # ç°æ”¹ä¸ºï¼š
         mv .config out/.config

         # ã€æ–°å¢ã€‘ä»¥ä¸‹ echo å‘½ä»¤ï¼Œå°†åŸå…ˆ "Add SUSFS and Compression Configuration Settings" æ­¥éª¤ä¸­çš„é…ç½®é¡¹æ·»åŠ åˆ° out/.config
         echo "CONFIG_KSU=y" >> out/.config
         echo "CONFIG_KSU_SUSFS_SUS_SU=n" >> out/.config
         echo "CONFIG_KSU_MANUAL_HOOK=y" >> out/.config
         echo "CONFIG_KSU_SUSFS=y" >> out/.config
         echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> out/.config
         echo "CONFIG_KSU_SUSFS_SUS_PATH=n" >> out/.config
         echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> out/.config
         echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> out/.config
         echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> out/.config
         echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> out/.config
         echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n" >> out/.config
         echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> out/.config
         echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> out/.config
         echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> out/.config
         echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> out/.config
         echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> out/.config
         echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> out/.config
         echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> out/.config
         echo "CONFIG_CRYPTO_LZ4HC=y" >> out/.config
         echo "CONFIG_CRYPTO_LZ4K=y" >> out/.config
         echo "CONFIG_CRYPTO_LZ4KD=y" >> out/.config
         echo "CONFIG_F2FS_FS_LZ4HC=y" >> out/.config
         echo "CONFIG_CRYPTO_ZSTD=y" >> out/.config
         echo "CONFIG_CRYPTO_LZ4=y" >> out/.config
         echo "CONFIG_CRYPTO_842=y" >> out/.config
         echo "CONFIG_ZRAM=y" >> out/.config
         echo "CONFIG_ZRAM_LZ4_COMPRESS=y" >> out/.config
         echo "CONFIG_ZRAM_LZ4KD_COMPRESS=y" >> out/.config
         echo "CONFIG_ZRAM_ZSTD_COMPRESS=y" >> out/.config
         echo "CONFIG_ZRAM_MULTI_COMP=y" >> out/.config
         echo "CONFIG_HZ_250=y" >> out/.config
         echo "CONFIG_NO_HZ_IDLE=y" >> out/.config
         echo "CONFIG_NET_SCHED=y" >> out/.config
         echo "CONFIG_TCP_CONG_ADVANCED=y" >> out/.config
         echo "CONFIG_TCP_CONG_BBR=y" >> out/.config
         echo "CONFIG_NET_SCH_FQ=y" >> out/.config
         echo "CONFIG_TCP_CONG_BIC=n" >> out/.config
         echo "CONFIG_TCP_CONG_CUBIC=n" >> out/.config
         echo "CONFIG_TCP_CONG_WESTWOOD=n" >> out/.config
         echo "CONFIG_TCP_CONG_HTCP=n" >> out/.config
         echo "CONFIG_DEFAULT_TCP_CONG=bbr" >> out/.config
         echo "CONFIG_SCHED_EEVDF=y" >> out/.config
         echo "CONFIG_F2FS_FS=y" >> out/.config
         echo "CONFIG_F2FS_STAT_FS=y" >> out/.config
         echo "CONFIG_F2FS_FS_XATTR=y" >> out/.config
         echo "CONFIG_F2FS_FS_POSIX_ACL=y" >> out/.config
         echo "CONFIG_F2FS_FS_SECURITY=y" >> out/.config
         echo "CONFIG_F2FS_CHECK_FS=y" >> out/.config
         echo "CONFIG_F2FS_IOSTAT=y" >> out/.config
         echo "CONFIG_F2FS_FAULT_INJECTION=n" >> out/.config
         echo "CONFIG_F2FS_HW_PCI_ROM=n" >> out/.config
         echo "CONFIG_F2FS_FS_ENCRYPTION=y" >> out/.config
         echo "CONFIG_F2FS_FS_COMPRESSION=y" >> out/.config
         echo "CONFIG_F2FS_FS_LZ4=y" >> out/.config
         echo "CONFIG_F2FS_FS_LZO=y" >> out/.config
         echo "CONFIG_F2FS_FS_ZSTD=y" >> out/.config

         # å¯ç”¨ AFDO ä¼˜åŒ–ï¼Œç¡®ä¿åœ¨ defconfig ä¹‹åå†™å…¥
         # ã€ä¿æŒä¸å˜ã€‘
         echo "CONFIG_FPROFILE_SAMPLE_PATH=\"kernel.afdo\"" >> out/.config # ä¿®æ­£ AFDO æ–‡ä»¶è·¯å¾„
         echo "CONFIG_FPROFILE_SAMPLE_USE=y" >> out/.config

         # å¯ç”¨ LTO ä¼˜åŒ–ï¼Œä½¿ç”¨ shell çš„æ¡ä»¶åˆ¤æ–­è¯­æ³•
         # ã€ä¿æŒä¸å˜ã€‘
         if [ "${{ inputs.ENABLE_LTO }}" = "true" ]; then
           echo "CONFIG_LTO_CLANG=y" >> out/.config
           echo "CONFIG_LTO=y" >> out/.config
         fi
         # --- ç»“æŸæ¸…ç†å’Œæ·»åŠ é…ç½® ---

         # ç¼–è¯‘å†…æ ¸
         # ã€ä¿æŒä¸å˜ã€‘
         make -j$(nproc --all)
         echo "Checking if ThinLTO was applied:"
         find out/ -name '*.cmd' | xargs grep -E '\-flto(=thin)?' | head


      # æ‰“å° ccache ä½¿ç”¨ç»Ÿè®¡
      - name: Show ccache stats
        run: ccache -s || true # æ˜¾ç¤º ccache ç»Ÿè®¡ä¿¡æ¯

      # æ­¥éª¤ï¼šéªŒè¯å†…æ ¸æ„å»ºæ—¶é—´
      - name: éªŒè¯å†…æ ¸æ„å»ºæ—¶é—´
        run: |
         strings kernel_workspace/kernel_platform/common/out/vmlinux | grep "UTC" || true # éªŒè¯å†…æ ¸æ„å»ºæ—¶é—´

      # æ­¥éª¤ï¼šåˆ¶ä½œ AnyKernel3 è¡¥ä¸ (å¯é€‰)
      - name: Make AnyKernel3 patch (optional)
        if: ${{ fromJSON(github.event.inputs.ENABLE_KPM) }} # å¦‚æœ ENABLE_KPM ä¸º true
        run: |
          cd kernel_workspace/kernel_platform/dist # è¿›å…¥ dist ç›®å½•
          curl -LO https://github.com/ShirkNeko/SukiSU_KernelPatch_patch/releases/download/0.11-beta/patch_linux # ä¸‹è½½ patch_linux å·¥å…·
          chmod +x patch_linux # æ·»åŠ æ‰§è¡Œæƒé™
          ./patch_linux # æ‰§è¡Œ patch_linux
          rm -f Image # ç§»é™¤ Image æ–‡ä»¶
          mv oImage Image # é‡å‘½å oImage ä¸º Image
      # æ­¥éª¤ï¼šå‡†å¤‡ AnyKernel3 åŒ…
      - name: Prepare AnyKernel3 package
        run: |
          cd kernel_workspace/kernel_platform/dist # è¿›å…¥ dist ç›®å½•
          git clone https://github.com/3620603660/AnyKernel3.git AnyKernel3 --depth=1 # å…‹éš† AnyKernel3 ä»“åº“
          rm -rf AnyKernel3/.git # ç§»é™¤ .git ç›®å½•
          rm -f AnyKernel3/push.sh # ç§»é™¤ push.sh è„šæœ¬
          cp Image AnyKernel3/ # å¤åˆ¶ Image æ–‡ä»¶åˆ° AnyKernel3 ç›®å½•
      # æ­¥éª¤ï¼šä¸Šä¼  AnyKernel3 Artifact
      - name: Upload AnyKernel3 artifact
        uses: actions/upload-artifact@v4 # ä½¿ç”¨ actions/upload-artifact@v4 åŠ¨ä½œä¸Šä¼  Artifact
        with:
          name: AnyKernel3_${{ github.event.inputs.FEIL }}_${{ env.KSUVER }} # Artifact åç§°
          path: kernel_workspace/kernel_platform/dist/AnyKernel3/* # Artifact è·¯å¾„


