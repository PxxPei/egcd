# ace5pro ä¸»å·¥ä½œæµ
# è¿™æ˜¯ä¸€ä¸ª GitHub Actions å·¥ä½œæµï¼Œç”¨äºç¼–è¯‘ Android å†…æ ¸ã€‚
# å®ƒå®šä¹‰äº†è§¦å‘æ¡ä»¶ã€è¾“å…¥å‚æ•°ä»¥åŠä¸€ç³»åˆ—æ„å»ºæ­¥éª¤ã€‚

name: ace5proä¸çŸ¥é“(ä¸»å·¥ä½œæµ)

# å®šä¹‰å·¥ä½œæµçš„è§¦å‘æ¡ä»¶
on:
  # å½“æ‰‹åŠ¨è§¦å‘å·¥ä½œæµæ—¶
  workflow_dispatch:
    # å®šä¹‰å·¥ä½œæµçš„è¾“å…¥å‚æ•°
    inputs:
      CPU:
        description: "åˆ†æ”¯åç§°ï¼Œä¾‹å¦‚ sm8750"
        required: true
        default: 'sm8750'
      FEIL:
        description: "é…ç½®æ–‡ä»¶åç§°ï¼Œä¾‹å¦‚ oneplus_ace5_pro"
        required: true
        default: 'oneplus_ace5_pro'
      ANDROID_VERSION:
        description: "å†…æ ¸å¯¹åº”çš„ Android ç‰ˆæœ¬ï¼Œä¾‹å¦‚ android15"
        required: true
        default: 'android15'
      KERNEL_VERSION:
        description: "å†…æ ¸ç‰ˆæœ¬ï¼Œä¾‹å¦‚ 6.6"
        required: true
        default: '6.6'
      KERNEL_NAME:
        description: "ä¿®æ”¹åçš„å†…æ ¸åç§°åç¼€"
        required: true
        default: '-android15-8-g013ec21bba94-abogki383916444'
      ENABLE_KPM:
        description: "æ˜¯å¦å¯ç”¨ KPM (Kernel Patch Manager)"
        required: false
        default: false
        type: boolean
      local_version:
        description: 'è¾“å…¥å†…æ ¸åç¼€åï¼ˆå¦‚-v8ï¼‰'
        required: false
        default: '-4k'
        type: string
      remove_default_4k:
        description: 'æ˜¯å¦åˆ é™¤é»˜è®¤çš„ -4k åç¼€ï¼Ÿï¼ˆå‹¾é€‰åˆ™åˆ é™¤ï¼‰'
        required: false
        default: false
        type: boolean
      kernel_time:
        description: 'å†…æ ¸æ„å»ºæ—¶é—´ï¼ˆUTC æ—¶é—´å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ "Tue Dec 17 23:36:49 UTC 2024"ï¼‰'
        required: false
        default: 'Tue Dec 17 23:36:49 UTC 2024'
        type: string
      ENABLE_LTO:
        description: 'å¯ç”¨ LTO (Link Time Optimization) é“¾æ¥æ—¶ä¼˜åŒ–'
        required: false
        default: false
        type: boolean

# å®šä¹‰å·¥ä½œæµä¸­çš„ä»»åŠ¡
jobs:
  build:
    # æŒ‡å®šè¿è¡Œç¯å¢ƒä¸ºæœ€æ–°çš„ Ubuntu
    runs-on: ubuntu-latest
    # å®šä¹‰ç¯å¢ƒå˜é‡
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      TOKEN: ${{ secrets.TOKEN }} # ä» GitHub Secrets è·å– TOKEN
    # å®šä¹‰æ„å»ºæ­¥éª¤
    steps:
      # æ­¥éª¤ï¼šæœ€å¤§åŒ–æ„å»ºç©ºé—´
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192 # æ ¹ç›®å½•ä¿ç•™ç©ºé—´
          temp-reserve-mb: 2048 # ä¸´æ—¶ç›®å½•ä¿ç•™ç©ºé—´
          remove-dotnet: 'true' # ç§»é™¤ .NET
          remove-android: 'true' # ç§»é™¤ Android SDK
          remove-haskell: 'true' # ç§»é™¤ Haskell
          remove-codeql: 'true' # ç§»é™¤ CodeQL
          
      # æ­¥éª¤ï¼šé…ç½® Git
      - name: Configure Git
        run: |
         git config --global user.name "build" # è®¾ç½® Git ç”¨æˆ·å
         git config --global user.email "3620603668@qq.com" # è®¾ç½® Git ç”¨æˆ·é‚®ç®±
      # 1. æ‹‰å–ä»“åº“  
      - name: Checkout  
        uses: actions/checkout@v4  # ä½¿ç”¨ actions/checkout@v4 åŠ¨ä½œæ‹‰å–ä»£ç 

      # 2. å®‰è£…æ„å»ºä¾èµ–ï¼ˆåŒ…æ‹¬ ccacheï¼‰  
      - name: Install Dependencies  
        run: |  
         sudo apt-get update  # æ›´æ–° apt åŒ…åˆ—è¡¨
         sudo apt-get install -y python3 git curl ccache libelf-dev  # å®‰è£…å¿…è¦çš„ä¾èµ–ï¼šPython3, Git, Curl, ccache, libelf-dev
      # 3. æ¢å¤ ccache ç¼“å­˜  
      - name: Restore ccache
        uses: actions/cache@v3 # ä½¿ç”¨ actions/cache@v3 åŠ¨ä½œæ¢å¤ ccache ç¼“å­˜
        with:
         path: /home/runner/.ccache # ccache ç¼“å­˜è·¯å¾„
         key: ${{ runner.os }}-${{ github.repository }}-ccache-${{ github.workflow }}-v3 # ç¼“å­˜é”®
         restore-keys: | # æ¢å¤é”®åˆ—è¡¨
          ${{ runner.os }}-${{ github.repository }}-ccache-${{ github.workflow }}-
          ${{ runner.os }}-${{ github.repository }}-
          ${{ runner.os }}-
      # 4. è®¾ç½® ccache ç¯å¢ƒå˜é‡  
      - name: Setup ccache environment  
        run: |  
         echo "CCACHE_DIR=/home/runner/.ccache" >> $GITHUB_ENV  # è®¾ç½® ccache ç›®å½•
         echo "CCACHE_MAXSIZE=8G" >> $GITHUB_ENV  # è®¾ç½® ccache æœ€å¤§å¤§å°
         echo "CCACHE_COMPILERCHECK=%compiler% -dumpmachine; %compiler% -dumpversion" >> $GITHUB_ENV  # è®¾ç½®ç¼–è¯‘å™¨æ£€æŸ¥
         echo "CCACHE_NOHASHDIR=true" >> $GITHUB_ENV  # ä¸å¯¹ç›®å½•è¿›è¡Œå“ˆå¸Œ
         echo "CCACHE_HARDLINK=true" >> $GITHUB_ENV  # ä½¿ç”¨ç¡¬é“¾æ¥
         echo "CCACHE_BASEDIR=${{ github.workspace }}" >> $GITHUB_ENV  # è®¾ç½® ccache åŸºç¡€ç›®å½•
         echo "CCACHE_LOGFILE=${{ github.workspace }}/ccache.log" >> $GITHUB_ENV  # è®¾ç½® ccache æ—¥å¿—æ–‡ä»¶
         echo "/usr/lib/ccache" >> $GITHUB_PATH  # å°† ccache æ·»åŠ åˆ° PATH ç¯å¢ƒå˜é‡
         
      # æ­¥éª¤ï¼šæ˜¾ç¤º ccache ç»Ÿè®¡ä¿¡æ¯
      - name: Show ccache stats
        run: |
         ccache -s || true # æ˜¾ç¤º ccache ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚æœå¤±è´¥åˆ™å¿½ç•¥é”™è¯¯
      # æ­¥éª¤ï¼šå®‰è£… repo å·¥å…·
      - name: Install repo tool
        run: |
         curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo # ä¸‹è½½ repo å·¥å…·
         chmod a+x ~/repo # æ·»åŠ æ‰§è¡Œæƒé™
         sudo mv ~/repo /usr/local/bin/repo # å°† repo ç§»åŠ¨åˆ° /usr/local/bin
      # æ­¥éª¤ï¼šåˆå§‹åŒ– repo å¹¶åŒæ­¥ä»£ç 
      - name: Initialize repo and sync
        run: |
         mkdir kernel_workspace && cd kernel_workspace # åˆ›å»ºå†…æ ¸å·¥ä½œç©ºé—´å¹¶è¿›å…¥
         repo init -u https://github.com/OnePlusOSS/kernel_manifest.git -b refs/heads/oneplus/${{ github.event.inputs.CPU }} -m ${{ github.event.inputs.FEIL }}.xml --depth=1 # åˆå§‹åŒ– repo
         repo --trace sync -c -j$(nproc --all) --no-tags # åŒæ­¥ä»£ç 
         rm kernel_platform/common/android/abi_gki_protected_exports_* || echo "No protected exports!" # ç§»é™¤å—ä¿æŠ¤çš„å¯¼å‡ºæ–‡ä»¶
         rm kernel_platform/msm-kernel/android/abi_gki_protected_exports_* || echo "No protected exports!" # ç§»é™¤å—ä¿æŠ¤çš„å¯¼å‡ºæ–‡ä»¶
         
      # æ­¥éª¤ï¼šè®¾ç½® SukiSU
      - name: Set up SukiSU
        run: |
         cd kernel_workspace/kernel_platform # è¿›å…¥å†…æ ¸å¹³å°ç›®å½•
         curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-main # ä¸‹è½½å¹¶æ‰§è¡Œ SukiSU å®‰è£…è„šæœ¬
         cd ./KernelSU # è¿›å…¥ KernelSU ç›®å½•
         KSU_VERSION=$(expr $(/usr/bin/git rev-list --count main) "+" 10606) # è®¡ç®— KSU ç‰ˆæœ¬å·
         echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV # è®¾ç½® KSUVER ç¯å¢ƒå˜é‡
         export KSU_VERSION=$KSU_VERSION # å¯¼å‡º KSU_VERSION ç¯å¢ƒå˜é‡
         sed -i "s/DKSU_VERSION=12800/DKSU_VERSION=${KSU_VERSION}/" kernel/Makefile # ä¿®æ”¹ KernelSU çš„ Makefile
      # æ­¥éª¤ï¼šè®¾ç½® SUSFS å¹¶åº”ç”¨è¡¥ä¸
      - name: Set up SUSFS & apply patches
        run: |
         set -e # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
         cd kernel_workspace # è¿›å…¥å†…æ ¸å·¥ä½œç©ºé—´
         git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-${{ inputs.ANDROID_VERSION }}-${{ inputs.KERNEL_VERSION }} # å…‹éš† susfs4ksu ä»“åº“
         git clone --depth=1 https://github.com/SukiSU-Ultra/SukiSU_patch.git # å…‹éš† SukiSU_patch ä»“åº“
         git clone https://$TOKEN@github.com/3620603660/boot.git # å…‹éš† boot ä»“åº“
         cd kernel_platform # è¿›å…¥å†…æ ¸å¹³å°ç›®å½•
         cp ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ inputs.ANDROID_VERSION }}-${{ inputs.KERNEL_VERSION }}.patch ./common/ || true # å¤åˆ¶ SUSFS è¡¥ä¸
         mkdir -p ./common/fs ./common/include/linux ./common/lib ./common/crypto # åˆ›å»ºç›®å½•
         cp ../susfs4ksu/kernel_patches/fs/* ./common/fs/ || true # å¤åˆ¶æ–‡ä»¶ç³»ç»Ÿç›¸å…³è¡¥ä¸
         cp ../susfs4ksu/kernel_patches/include/linux/* ./common/include/linux/ || true # å¤åˆ¶ Linux å¤´æ–‡ä»¶ç›¸å…³è¡¥ä¸
         cp -r ../SukiSU_patch/other/zram/lz4k/include/linux/* ./common/include/linux || true # å¤åˆ¶ LZ4K ç›¸å…³å¤´æ–‡ä»¶
         cp -r ../SukiSU_patch/other/zram/lz4k/lib/* ./common/lib || true # å¤åˆ¶ LZ4K ç›¸å…³åº“æ–‡ä»¶
         cp -r ../SukiSU_patch/other/zram/lz4k/crypto/* ./common/crypto || true # å¤åˆ¶ LZ4K ç›¸å…³åŠ å¯†æ–‡ä»¶
         cp -r ../SukiSU_patch/other/zram/lz4k_oplus ./common/lib/ || true # å¤åˆ¶ LZ4K Oplus ç›¸å…³æ–‡ä»¶
         cp ../boot/1.patch ./common/ # å¤åˆ¶ boot è¡¥ä¸
         cd ./common # è¿›å…¥ common ç›®å½•
         PATCH_FILE=50_add_susfs_in_gki-${{ inputs.ANDROID_VERSION }}-${{ inputs.KERNEL_VERSION }}.patch # å®šä¹‰è¡¥ä¸æ–‡ä»¶å˜é‡
         if [[ -f "$PATCH_FILE" ]]; then # å¦‚æœè¡¥ä¸æ–‡ä»¶å­˜åœ¨
         sed -i 's/-32,12 +32,38/-32,11 +32,37/g' "$PATCH_FILE" # ä¿®æ”¹è¡¥ä¸æ–‡ä»¶å†…å®¹
         sed -i '/#include <trace\/hooks\/fs.h>/d' "$PATCH_FILE" # åˆ é™¤è¡¥ä¸æ–‡ä»¶ä¸­çš„ç‰¹å®šè¡Œ
         patch -p1 < "$PATCH_FILE" || true # åº”ç”¨è¡¥ä¸
         fi
         cp ../../SukiSU_patch/hooks/syscall_hooks.patch ./ # å¤åˆ¶ syscall_hooks è¡¥ä¸
         patch -p1 -F 3 < syscall_hooks.patch || true # åº”ç”¨ syscall_hooks è¡¥ä¸
         patch -s -p1 -F 3 < 1.patch # åº”ç”¨ 1.patch è¡¥ä¸
         echo "âœ… SUSFS å’Œ syscall_hooks patch åº”ç”¨å®Œæˆ" # è¾“å‡ºæˆåŠŸä¿¡æ¯

      # æ­¥éª¤ï¼šåº”ç”¨ lz4kd è¡¥ä¸å¹¶æ›´æ–°å‹ç¼©åº“
      - name: Apply lz4kd Patches and Update Compression Libraries
        run: |
         set -e # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
         cd kernel_workspace/kernel_platform/common # è¿›å…¥ common ç›®å½•
         PATCH_FILE=../../SukiSU_patch/other/zram/zram_patch/${{ inputs.KERNEL_VERSION }}/lz4kd.patch # å®šä¹‰ lz4kd è¡¥ä¸æ–‡ä»¶å˜é‡
         if [[ -f "$PATCH_FILE" ]]; then # å¦‚æœè¡¥ä¸æ–‡ä»¶å­˜åœ¨
         cp "$PATCH_FILE" ./lz4kd.patch # å¤åˆ¶ lz4kd è¡¥ä¸
         patch -p1 -F 3 < lz4kd.patch || true # åº”ç”¨ lz4kd è¡¥ä¸
         else
         echo "â— lz4kd patch not found for kernel version ${{ inputs.KERNEL_VERSION }}" # è¾“å‡ºè­¦å‘Šä¿¡æ¯
         fi

      - name: ğŸ”§ Update compression algorithms (æ›´æ–°å‹ç¼©ç®—æ³•)
        run: |
          cd kernel_workspace/kernel_platform/common
          # æ›´æ–° LZ4 å®ç°
          curl -sSLO https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/lib/lz4/lz4_decompress.c # ä¸‹è½½ LZ4 è§£å‹ä»£ç 
          curl -sSLO https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/lib/lz4/lz4defs.h # ä¸‹è½½ LZ4 å®šä¹‰å¤´æ–‡ä»¶
          curl -sSLO https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/lib/lz4/lz4_compress.c # ä¸‹è½½ LZ4 å‹ç¼©ä»£ç 
          curl -sSLO https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/lib/lz4/lz4hc_compress.c # ä¸‹è½½ LZ4HC å‹ç¼©ä»£ç 


           # æ›´æ–° Zstd å®ç° 
          zstd_base="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/lib/zstd" # Zstd åº“åŸºç¡€ URL
          mkdir -p lib/zstd && cd lib/zstd # åˆ›å»º lib/zstd ç›®å½•å¹¶è¿›å…¥
          curl -sSL $zstd_base/zstd_common_module.c -o common.c # ä¸‹è½½ Zstd å…¬å…±æ¨¡å—
          curl -sSL $zstd_base/compress/zstd_compress_module.c -o compress.c # ä¸‹è½½ Zstd å‹ç¼©æ¨¡å—
          curl -sSL $zstd_base/decompress/zstd_decompress_module.c -o decompress.c # ä¸‹è½½ Zstd è§£å‹æ¨¡å—
          curl -sSL $zstd_base/zstd_compat.h -o compat.h # ä¸‹è½½ Zstd å…¼å®¹å¤´æ–‡ä»¶
          cd .. # è¿”å› common ç›®å½•

      # æ­¥éª¤ï¼šæ·»åŠ  SUSFS å’Œå‹ç¼©é…ç½®è®¾ç½®
      - name: Add SUSFS and Compression Configuration Settings
        run: |
          cd kernel_workspace/kernel_platform # è¿›å…¥å†…æ ¸å¹³å°ç›®å½•
          echo "CONFIG_KSU=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KSU
          # æ·»åŠ  VFS é…ç½®è®¾ç½®
          echo "CONFIG_KSU_SUSFS_SUS_SU=n" >> ./common/arch/arm64/configs/gki_defconfig # ç¦ç”¨ KSU_SUSFS_SUS_SU
          echo "CONFIG_KSU_MANUAL_HOOK=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KSU æ‰‹åŠ¨ Hook
          
          # æ·»åŠ  SUSFS é…ç½®è®¾ç½®
          echo "CONFIG_KSU_SUSFS=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KSU_SUSFS
          echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KSU_SUSFS_HAS_MAGIC_MOUNT
          echo "CONFIG_KSU_SUSFS_SUS_PATH=n" >> ./common/arch/arm64/configs/gki_defconfig # ç¦ç”¨ KSU_SUSFS_SUS_PATH
          echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KSU_SUSFS_SUS_MOUNT
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT
          echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KSU_SUSFS_SUS_KSTAT
          echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n" >> ./common/arch/arm64/configs/gki_defconfig # ç¦ç”¨ KSU_SUSFS_SUS_OVERLAYFS
          echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KSU_SUSFS_TRY_UMOUNT
          echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT
          echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KSU_SUSFS_SPOOF_UNAME
          echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KSU_SUSFS æ—¥å¿—
          echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KSU_SUSFS éšè—ç¬¦å·
          echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KSU_SUSFS æ¬ºéª—å‘½ä»¤è¡Œæˆ–å¯åŠ¨é…ç½®
          echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KSU_SUSFS æ‰“å¼€é‡å®šå‘
          
          # ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„å‹ç¼©ç®—æ³•éƒ½å·²å¯ç”¨
          echo "CONFIG_CRYPTO_LZ4HC=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ LZ4HC åŠ å¯†
          echo "CONFIG_CRYPTO_LZ4K=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ LZ4K åŠ å¯†
          echo "CONFIG_CRYPTO_LZ4KD=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ LZ4KD åŠ å¯†
          echo "CONFIG_F2FS_FS_LZ4HC=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ F2FS æ–‡ä»¶ç³»ç»Ÿ LZ4HC å‹ç¼©
          echo "CONFIG_CRYPTO_ZSTD=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ ZSTD åŠ å¯†
          echo "CONFIG_CRYPTO_LZ4=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ LZ4 åŠ å¯†
          echo "CONFIG_CRYPTO_842=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ 842 åŠ å¯†

          # å¯ç”¨ ZRAM åŠå…¶å‹ç¼©é€‰é¡¹
          echo "CONFIG_ZRAM=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ ZRAM
          echo "CONFIG_ZRAM_LZ4_COMPRESS=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ ZRAM LZ4 å‹ç¼©
          echo "CONFIG_ZRAM_LZ4KD_COMPRESS=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ ZRAM LZ4KD å‹ç¼©
          echo "CONFIG_ZRAM_ZSTD_COMPRESS=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ ZRAM ZSTD å‹ç¼©
          echo "CONFIG_ZRAM_MULTI_COMP=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ ZRAM å¤šå‹ç¼©å™¨æ”¯æŒ

          # æ·»åŠ  BBR å’Œé€šç”¨ Linux ä¼˜åŒ–è®¾ç½®
          echo "CONFIG_HZ_250=y" >> ./common/arch/arm64/configs/gki_defconfig # è®¾ç½®æ—¶é’Ÿé¢‘ç‡ä¸º 250Hz
          echo "CONFIG_NO_HZ_IDLE=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ç©ºé—²æ—¶æ— æ—¶é’ŸèŠ‚æ‹
          echo "CONFIG_NET_SCHED=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ç½‘ç»œè°ƒåº¦
          echo "CONFIG_TCP_CONG_ADVANCED=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨é«˜çº§ TCP æ‹¥å¡æ§åˆ¶
          echo "CONFIG_TCP_CONG_BBR=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ BBR TCP æ‹¥å¡æ§åˆ¶ç®—æ³•
          echo "CONFIG_NET_SCH_FQ=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ FQ ç½‘ç»œè°ƒåº¦å™¨
          echo "CONFIG_TCP_CONG_BIC=n" >> ./common/arch/arm64/configs/gki_defconfig # ç¦ç”¨ BIC TCP æ‹¥å¡æ§åˆ¶ç®—æ³•
          echo "CONFIG_TCP_CONG_CUBIC=n" >> ./common/arch/arm64/configs/gki_defconfig # ç¦ç”¨ CUBIC TCP æ‹¥å¡æ§åˆ¶ç®—æ³•
          echo "CONFIG_TCP_CONG_WESTWOOD=n" >> ./common/arch/arm64/configs/gki_defconfig # ç¦ç”¨ WESTWOOD TCP æ‹¥å¡æ§åˆ¶ç®—æ³•
          echo "CONFIG_TCP_CONG_HTCP=n" >> ./common/arch/arm64/configs/gki_defconfig # ç¦ç”¨ HTCP TCP æ‹¥å¡æ§åˆ¶ç®—æ³•
          echo "CONFIG_DEFAULT_TCP_CONG=bbr" >> ./common/arch/arm64/configs/gki_defconfig # è®¾ç½®é»˜è®¤ TCP æ‹¥å¡æ§åˆ¶ç®—æ³•ä¸º BBR
          echo "CONFIG_SCHED_EEVDF=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ EEVDF è°ƒåº¦å™¨
          echo "CONFIG_F2FS_FS=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ F2FS æ–‡ä»¶ç³»ç»Ÿ
          echo "CONFIG_F2FS_STAT_FS=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ F2FS ç»Ÿè®¡ä¿¡æ¯
          echo "CONFIG_F2FS_FS_XATTR=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ F2FS æ‰©å±•å±æ€§
          echo "CONFIG_F2FS_FS_POSIX_ACL=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ F2FS POSIX ACL
          echo "CONFIG_F2FS_FS_SECURITY=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ F2FS å®‰å…¨æ€§
          echo "CONFIG_F2FS_CHECK_FS=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ F2FS æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥
          echo "CONFIG_F2FS_IOSTAT=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ F2FS IO ç»Ÿè®¡
          echo "CONFIG_F2FS_FAULT_INJECTION=n" >> ./common/arch/arm64/configs/gki_defconfig # ç¦ç”¨ F2FS æ•…éšœæ³¨å…¥
          echo "CONFIG_F2FS_HW_PCI_ROM=n" >> ./common/arch/arm64/configs/gki_defconfig # ç¦ç”¨ F2FS ç¡¬ä»¶ PCI ROM
          echo "CONFIG_F2FS_FS_ENCRYPTION=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ F2FS æ–‡ä»¶ç³»ç»ŸåŠ å¯†
          echo "CONFIG_F2FS_FS_COMPRESSION=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ F2FS æ–‡ä»¶ç³»ç»Ÿå‹ç¼©
          echo "CONFIG_F2FS_FS_LZ4=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ F2FS æ–‡ä»¶ç³»ç»Ÿ LZ4 å‹ç¼©
          echo "CONFIG_F2FS_FS_LZO=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ F2FS æ–‡ä»¶ç³»ç»Ÿ LZO å‹ç¼©
          echo "CONFIG_F2FS_FS_ZSTD=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ F2FS æ–‡ä»¶ç³»ç»Ÿ ZSTD å‹ç¼©
          sed -i 's/check_defconfig//' ./common/build.config.gki # ç§»é™¤ build.config.gki ä¸­çš„ check_defconfig
         
          # ç§»é™¤ check_defconfig
          sed -i 's/check_defconfig//' ./common/build.config.gki # å†æ¬¡ç§»é™¤ build.config.gki ä¸­çš„ check_defconfig
          cd common # è¿›å…¥ common ç›®å½•
          git add -A && git commit -a -m "BUILD Kernel" # æ·»åŠ æ‰€æœ‰æ›´æ”¹å¹¶æäº¤
          
      # æ­¥éª¤ï¼šå¯ç”¨ KPM (Kernel Patch Manager)
      - name: å¯ç”¨kpm
        if: ${{ fromJSON(github.event.inputs.ENABLE_KPM) }} # å¦‚æœ ENABLE_KPM ä¸º true
        run: |
         cd kernel_workspace/kernel_platform # è¿›å…¥å†…æ ¸å¹³å°ç›®å½•
         echo "CONFIG_KPM=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ KPM
         sudo sed -i 's/check_defconfig//' ./common/build.config.gki # ç§»é™¤ build.config.gki ä¸­çš„ check_defconfig
         cd common # è¿›å…¥ common ç›®å½•
         git add -A && git commit -a -m "BUILD Kernel" # æ·»åŠ æ‰€æœ‰æ›´æ”¹å¹¶æäº¤

      # æ­¥éª¤ï¼šå¯ç”¨ LTO (Link Time Optimization)
      - name: å¯ç”¨LTO
        if: ${{ fromJSON(github.event.inputs.ENABLE_LTO) }} # å¦‚æœ ENABLE_LTO ä¸º true
        run: |
         cd kernel_workspace/kernel_platform # è¿›å…¥å†…æ ¸å¹³å°ç›®å½•
         echo "CONFIG_LTO_CLANG=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ CLANG LTO
         echo "CONFIG_LTO_CLANG_THIN=y" >> ./common/arch/arm64/configs/gki_defconfig # å¯ç”¨ CLANG ThinLTO
         sudo sed -i 's/check_defconfig//' ./common/build.config.gki # ç§»é™¤ build.config.gki ä¸­çš„ check_defconfig
         cd common # è¿›å…¥ common ç›®å½•
         git add -A && git commit -a -m "BUILD Kernel with LTO enabled" # æ·»åŠ æ‰€æœ‰æ›´æ”¹å¹¶æäº¤

      # æ­¥éª¤ï¼šæ·»åŠ  make åç§°
      - name: Add make name
        run: |
         cd kernel_workspace/kernel_platform # è¿›å…¥å†…æ ¸å¹³å°ç›®å½•
         sed -i '186s|echo ".*"|echo "${KERNELVERSION}${scm_version}${config_localversion}"|' common/scripts/setlocalversion # ä¿®æ”¹ setlocalversion è„šæœ¬
         sed -i "s/\${scm_version}/${{ github.event.inputs.KERNEL_NAME }}/g" ./common/scripts/setlocalversion # æ›¿æ¢ scm_version ä¸ºè¾“å…¥çš„å†…æ ¸åç§°
         
      # æ­¥éª¤ï¼šè®¾ç½® CONFIG_LOCALVERSION
      - name: è®¾ç½® CONFIG_LOCALVERSION
        run: |
         cd kernel_workspace/kernel_platform # è¿›å…¥å†…æ ¸å¹³å°ç›®å½•
         echo 'CONFIG_LOCALVERSION="${{ github.event.inputs.local_version }}"' >> ./common/arch/arm64/configs/gki_defconfig # è®¾ç½® CONFIG_LOCALVERSION

      # æ­¥éª¤ï¼šåˆ é™¤ CONFIG_LOCALVERSION ä¸­çš„ -4k åç¼€ï¼ˆå¦‚æœå‹¾é€‰ï¼‰
      - name: åˆ é™¤ CONFIG_LOCALVERSION ä¸­çš„ -4k åç¼€ï¼ˆå¦‚æœå‹¾é€‰ï¼‰
        if: ${{ fromJSON(github.event.inputs.remove_default_4k) }} # å¦‚æœ remove_default_4k ä¸º true
        run: |
         cd kernel_workspace/kernel_platform # è¿›å…¥å†…æ ¸å¹³å°ç›®å½•
         sed -i 's/-4k//' ./common/arch/arm64/configs/gki_defconfig # åˆ é™¤ -4k åç¼€
    
      # æ­¥éª¤ï¼šæ·»åŠ  sched_ext
      - name: Add sched_ext
        run: |
         cd kernel_workspace/kernel_platform/ # è¿›å…¥å†…æ ¸å¹³å°ç›®å½•
         git clone https://github.com/3620603660/sched_ext.git # å…‹éš† sched_ext ä»“åº“
         cp -r ./sched_ext/* ./common/kernel/sched # å¤åˆ¶ sched_ext æ–‡ä»¶
         rm -rf ./sched_ext/.git # ç§»é™¤ .git ç›®å½•
         
      # æ­¥éª¤ï¼šè®¾ç½®æ„å»ºæ—¶é—´æˆ³
      - name: Set build timestamp
        run: |         
         export SOURCE_DATE_EPOCH=$(date -d "Tue Dec 17 23:36:49 UTC 2024" +%s) # è®¾ç½® SOURCE_DATE_EPOCH ç¯å¢ƒå˜é‡
         echo "SOURCE_DATE_EPOCH=$SOURCE_DATE_EPOCH" >> $GITHUB_ENV # å°† SOURCE_DATE_EPOCH å†™å…¥ç¯å¢ƒå˜é‡
         
      # 5. ç¼–è¯‘å†…æ ¸   
      - name: Build Kernel
        run: |
         # åŠ å…¥ clang åˆ° PATH
         export PATH="${{ github.workspace }}/kernel_workspace/kernel_platform/prebuilts/clang/host/linux-x86/clang-r510928/bin:$PATH" # å°† clang æ·»åŠ åˆ° PATH
         # åŠ å…¥ ccache åˆ° PATH
         export PATH="/usr/lib/ccache:$PATH" # å°† ccache æ·»åŠ åˆ° PATH
         # è®¾ç½®å›ºå®šå†…æ ¸æ„å»ºæ—¶é—´
         export KERNEL_TIME="Tue Dec 17 23:36:49 UTC 2024" # è®¾ç½® KERNEL_TIME ç¯å¢ƒå˜é‡
         export KBUILD_BUILD_TIMESTAMP="$KERNEL_TIME" # è®¾ç½® KBUILD_BUILD_TIMESTAMP ç¯å¢ƒå˜é‡
         export SOURCE_DATE_EPOCH=$(date -d "$KERNEL_TIME" +%s) # è®¾ç½® SOURCE_DATE_EPOCH ç¯å¢ƒå˜é‡
         # æ‰“å°éªŒè¯
         echo "KERNEL_TIME = $KERNEL_TIME" # æ‰“å° KERNEL_TIME
         echo "SOURCE_DATE_EPOCH = $SOURCE_DATE_EPOCH" # æ‰“å° SOURCE_DATE_EPOCH
         # è®¾ç½®åŸºç¡€æ„å»ºå‚æ•°
         export MAKE_ARGS="LLVM=1 ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC=clang \
         RUSTC=../../prebuilts/rust/linux-x86/1.73.0b/bin/rustc \
         PAHOLE=../../prebuilts/kernel-build-tools/linux-x86/bin/pahole \
         LD=ld.lld HOSTLD=ld.lld O=out SOURCE_DATE_EPOCH=${SOURCE_DATE_EPOCH}" # è®¾ç½® make å‚æ•°
         echo "Using SOURCE_DATE_EPOCH: $SOURCE_DATE_EPOCH" # æ‰“å°ä½¿ç”¨çš„ SOURCE_DATE_EPOCH
         # è¿›å…¥æºç ç›®å½•
         cd kernel_workspace/kernel_platform/common # è¿›å…¥ common ç›®å½•
         # æ‰§è¡Œ defconfig
         make -j$(nproc) $MAKE_ARGS gki_defconfig # æ‰§è¡Œ defconfig
         # ç¼–è¯‘å†…æ ¸ï¼ˆä½¿ç”¨ -O3 ä¼˜åŒ–ï¼Œå…³é—­ warning->errorï¼‰
         KBUILD_CFLAGS='-O3' KCFLAGS='-Wno-error' make -j$(nproc) $MAKE_ARGS all # ç¼–è¯‘å†…æ ¸ï¼Œå¯ç”¨ O3 ä¼˜åŒ–å¹¶å…³é—­è­¦å‘Šè½¬é”™è¯¯
         echo "Checking compiled optimization level:" # æ£€æŸ¥ç¼–è¯‘ä¼˜åŒ–çº§åˆ«
         find out/ -name '*.cmd' | xargs grep -- '-O' | grep -v 'O2' | head # æŸ¥æ‰¾ç¼–è¯‘ä¼˜åŒ–çº§åˆ«
         echo "Checking if ThinLTO was applied:" # æ£€æŸ¥æ˜¯å¦åº”ç”¨äº† ThinLTO
         find out/ -name '*.cmd' | xargs grep -E '\-flto(=thin)?' | head # æŸ¥æ‰¾ ThinLTO åº”ç”¨æƒ…å†µ
         # åˆ›å»ºè¾“å‡ºç›®å½•å¹¶å¤åˆ¶ Image
         mkdir -p ../dist # åˆ›å»º dist ç›®å½•
         cp out/arch/arm64/boot/Image ../dist/ # å¤åˆ¶ Image æ–‡ä»¶åˆ° dist ç›®å½•
         
      # 6. æ‰“å° ccache ä½¿ç”¨ç»Ÿè®¡
      - name: Show ccache stats
        run: ccache -s || true # æ˜¾ç¤º ccache ç»Ÿè®¡ä¿¡æ¯

      # æ­¥éª¤ï¼šéªŒè¯å†…æ ¸æ„å»ºæ—¶é—´
      - name: éªŒè¯å†…æ ¸æ„å»ºæ—¶é—´
        run: |
         strings kernel_workspace/kernel_platform/common/out/vmlinux | grep "UTC" # éªŒè¯å†…æ ¸æ„å»ºæ—¶é—´

      # æ­¥éª¤ï¼šåˆ¶ä½œ AnyKernel3 è¡¥ä¸ (å¯é€‰)
      - name: Make AnyKernel3 patch (optional)
        if: ${{ fromJSON(github.event.inputs.ENABLE_KPM) }} # å¦‚æœ ENABLE_KPM ä¸º true
        run: |
          cd kernel_workspace/kernel_platform/dist # è¿›å…¥ dist ç›®å½•
          curl -LO https://github.com/ShirkNeko/SukiSU_KernelPatch_patch/releases/download/0.11-beta/patch_linux # ä¸‹è½½ patch_linux å·¥å…·
          chmod +x patch_linux # æ·»åŠ æ‰§è¡Œæƒé™
          ./patch_linux # æ‰§è¡Œ patch_linux
          rm -f Image # ç§»é™¤ Image æ–‡ä»¶
          mv oImage Image # é‡å‘½å oImage ä¸º Image

      # æ­¥éª¤ï¼šå‡†å¤‡ AnyKernel3 åŒ…
      - name: Prepare AnyKernel3 package
        run: |
          cd kernel_workspace/kernel_platform/dist # è¿›å…¥ dist ç›®å½•
          git clone https://github.com/3620603660/AnyKernel3.git AnyKernel3 --depth=1 # å…‹éš† AnyKernel3 ä»“åº“
          rm -rf AnyKernel3/.git # ç§»é™¤ .git ç›®å½•
          rm -f AnyKernel3/push.sh # ç§»é™¤ push.sh è„šæœ¬
          cp Image AnyKernel3/ # å¤åˆ¶ Image æ–‡ä»¶åˆ° AnyKernel3 ç›®å½•
      # æ­¥éª¤ï¼šä¸Šä¼  AnyKernel3 Artifact
      - name: Upload AnyKernel3 artifact
        uses: actions/upload-artifact@v4 # ä½¿ç”¨ actions/upload-artifact@v4 åŠ¨ä½œä¸Šä¼  Artifact
        with:
          name: AnyKernel3_${{ github.event.inputs.FEIL }}_${{ env.KSUVER }} # Artifact åç§°
          path: kernel_workspace/kernel_platform/dist/AnyKernel3/* # Artifact è·¯å¾„